services:

  samba:
    container_name: samba
    hostname: ${DC_NAME}
    build: ./dockerfile
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./config:/etc/samba/config
      - ./data:/var/lib/samba
      - ./shares:/shares
    environment:
      - DOMAIN_FQDN=${DOMAIN_FQDN}
      - DOMAIN_DN=${DOMAIN_DN}
      - DOMAIN_EMAIL=${DOMAIN_EMAIL}
      - DNSFORWARDER=${MAIN_DNS_IP}
      - DC_IP=${DC_IP}
      - RPC_PORT_RANGE=${RPC_PORT_RANGE}
    ports:
      - ${DC_IP}:53:53                                # DNS
      - ${DC_IP}:53:53/udp                            # DNS
      - ${DC_IP}:88:88                                # Kerberos
      - ${DC_IP}:88:88/udp                            # Kerberos
      - ${DC_IP}:123:123/udp                          # NTP
      - ${DC_IP}:135:135                              # RPC endpoint mapper
      - ${DC_IP}:389:389                              # LDAP
      - ${DC_IP}:389:389/udp                          # LDAP
      - ${DC_IP}:445:445                              # SMB
      - ${DC_IP}:464:464                              # Kerberos password change
      - ${DC_IP}:464:464/udp                          # Kerberos password change
      - ${DC_IP}:636:636                              # LDAPS
      - ${DC_IP}:3268-3269:3268-3269                  # Global catalog (SSL)
      - ${DC_IP}:${RPC_PORT_RANGE}:${RPC_PORT_RANGE}  # RPC
    dns_search:
      - ${DOMAIN_FQDN}
    dns:
      - ${DC_IP}
      - ${MAIN_DNS_IP}
    extra_hosts:
      - ${DC_NAME}.${DOMAIN_FQDN}:${DC_IP}
    privileged: true                                  # Run as true root. Required by Samba because it uses the security.* namespace (see https://www.samba.org/samba/docs/current/man-html/vfs_acl_xattr.8.html).
    networks:
      sambanet:
        ipv4_address: ${DC_IP}

networks:
  sambanet:
    driver: macvlan
    driver_opts:
      parent: ${HOST_INTERFACE}
    ipam:
      config:
        - subnet: "${DC_SUBNET}"                      # Shared with the host
          gateway: "${DC_GATEWAY}"                    # Same as on the host
          ip_range: "${DC_IP}/32"                     # Tell Docker which IP addresses are available for containers
